<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NederLingo | 日本語⇔オランダ語フレーズ学習</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f7f7fb;
      --fg: #1f2933;
      --accent: #ff7a59;
      --accent-dark: #c24e31;
      --card-bg: #ffffff;
      --muted: #5f6c7b;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --fg: #e2e8f0;
        --card-bg: #16203a;
        --muted: #8ea4c4;
      }

      .speech-feedback {
        background: rgba(148, 163, 184, 0.12);
        border-color: rgba(148, 163, 184, 0.2);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Helvetica Neue", sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 24px 20px 16px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.6rem, 4vw, 2.4rem);
      letter-spacing: 0.04em;
    }

    header p {
      margin: 12px auto 0;
      max-width: 720px;
      font-size: 1rem;
      color: var(--muted);
      line-height: 1.6;
    }

    main {
      flex: 1;
      width: min(960px, 92vw);
      margin: 0 auto 48px;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .mode-switcher {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .mode-button {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 51, 0.12);
      background: rgba(31, 41, 51, 0.04);
      color: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s ease-in-out, border 0.2s ease-in-out, color 0.2s ease-in-out;
    }

    .mode-button:hover,
    .mode-button:focus-visible {
      background: rgba(31, 41, 51, 0.08);
      border-color: rgba(31, 41, 51, 0.24);
      outline: none;
    }

    .mode-button[aria-selected="true"] {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }

    .mode-panel-group {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .mode-panel {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(15, 23, 42, 0.05);
    }

    .setup-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .setup-list li {
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(255, 122, 89, 0.08);
      border: 1px dashed rgba(255, 122, 89, 0.4);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .phrase-dutch {
      display: inline-block;
      font-weight: 600;
    }

    .phrase-note {
      display: block;
      margin-top: 4px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .phrase-actions {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(31, 41, 51, 0.16);
      background: rgba(31, 41, 51, 0.04);
      color: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
    }

    .icon-button:hover,
    .icon-button:focus-visible {
      background: rgba(31, 41, 51, 0.1);
      border-color: rgba(31, 41, 51, 0.32);
      outline: none;
      transform: translateY(-1px);
    }

    .icon-button:disabled {
      cursor: not-allowed;
      opacity: 0.55;
      transform: none;
    }

    .icon-button.is-active,
    .icon-button.is-recording {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .speech-toolbar {
      position: sticky;
      top: 12px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 16px;
      background: var(--card-bg);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.12);
    }

    .speech-toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: stretch;
    }

    .speech-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 0.9rem;
      color: var(--muted);
      flex: 1 1 200px;
    }

    .speech-controls label {
      font-weight: 600;
      color: var(--fg);
    }

    .speech-controls input[type="range"] {
      accent-color: var(--accent);
      min-width: 140px;
    }

    .speech-feedback {
      flex: 1 1 280px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.95rem;
      background: rgba(15, 23, 42, 0.05);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .speech-feedback-target {
      margin: 0;
      font-size: clamp(1.15rem, 2.8vw, 1.4rem);
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .speech-feedback-live {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .speech-feedback-live[hidden] {
      display: none;
    }

    .speech-feedback-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 0.95rem;
    }

    .speech-feedback-text {
      font-weight: 600;
      color: var(--fg);
    }

    .speech-feedback-score {
      font-weight: 600;
      color: var(--fg);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .speech-notice {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .is-hidden {
      display: none !important;
    }

    .phrase-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .phrase-section h3 {
      margin: 0;
      font-size: 1.35rem;
    }

    .game-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .game-intro p {
      margin: 0;
      line-height: 1.6;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .game-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      align-items: center;
    }

    .game-meta .meta-box {
      border-radius: 14px;
      background: rgba(31, 41, 51, 0.06);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .meta-label {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .meta-value {
      font-size: 1.35rem;
      font-weight: 700;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .meta-value small {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--muted);
    }

    .game-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .game-button {
      padding: 10px 18px;
      border-radius: 12px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      transition: transform 0.15s ease, background 0.2s ease;
    }

    .game-button:hover,
    .game-button:focus-visible {
      background: var(--accent-dark);
      transform: translateY(-1px);
      outline: none;
    }

    .game-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .game-button.secondary {
      background: rgba(31, 41, 51, 0.08);
      color: var(--fg);
    }

    .game-status {
      min-height: 1.4em;
      font-size: 0.95rem;
      color: var(--fg);
    }

    .game-card-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }

    .game-card-column {
      display: grid;
      grid-template-rows: repeat(5, minmax(0, auto));
      gap: 12px;
      align-content: start;
    }

    .game-card {
      position: relative;
      border-radius: 18px;
      padding: 12px;
      background: var(--card-bg);
      border: 2px solid transparent;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      transition: transform 0.18s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .game-card[data-lang="ja"] {
      background: linear-gradient(135deg, rgba(255, 225, 215, 0.45), rgba(255, 255, 255, 0.8));
    }

    .game-card[data-lang="nl"] {
      background: linear-gradient(135deg, rgba(210, 230, 255, 0.4), rgba(255, 255, 255, 0.85));
    }

    .game-card-main {
      width: 100%;
      border: none;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 14px;
      padding: 14px 12px;
      font-size: 1.05rem;
      font-weight: 600;
      text-align: center;
      color: var(--fg);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .game-card-text {
      display: block;
      line-height: 1.4;
    }

    .game-card[data-lang="nl"] .game-card-main {
      font-size: 1rem;
    }

    .game-card-main:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .game-card.is-selected {
      border-color: var(--accent);
      transform: translateY(-4px);
    }

    .game-card.is-matched {
      border-color: var(--accent);
      animation: cardMatch 520ms ease;
      box-shadow: 0 16px 32px rgba(255, 122, 89, 0.32);
    }

    .game-card.is-disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    .score-pulse {
      animation: scorePulse 420ms ease;
    }

    @keyframes scorePulse {
      0% {
        transform: scale(1);
      }

      40% {
        transform: scale(1.15);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes cardMatch {
      0% {
        transform: scale(0.96);
      }

      60% {
        transform: scale(1.08);
      }

      100% {
        transform: scale(1);
      }
    }

    .phrase-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.02);
    }

    .phrase-table th,
    .phrase-table td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(96, 110, 133, 0.18);
      text-align: left;
      vertical-align: top;
    }

    .phrase-table thead th {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .phrase-table tbody tr:last-child td {
      border-bottom: none;
    }

    .phrase-table td strong {
      display: block;
      font-size: 1rem;
    }

    @media (max-width: 640px) {
      .game-meta {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }

      .game-card-grid {
        gap: 14px;
      }

      .game-card-column {
        gap: 10px;
      }

      .game-card {
        padding: 10px;
      }

      .game-card-main {
        font-size: 1rem;
        padding: 12px 10px;
      }

      .phrase-table thead {
        display: none;
      }

      .phrase-table,
      .phrase-table tbody,
      .phrase-table tr,
      .phrase-table td {
        display: block;
        width: 100%;
      }

      .phrase-table tr {
        padding: 12px 0;
        border-bottom: 1px solid rgba(96, 110, 133, 0.18);
      }

      .phrase-table tbody tr:last-child {
        border-bottom: none;
      }

      .phrase-table td {
        border: none;
        padding: 6px 0;
      }

      .phrase-table td::before {
        content: attr(data-label);
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .phrase-actions {
        margin-top: 10px;
      }

      .icon-button {
        width: 34px;
        height: 34px;
      }
    }

    @media (max-width: 480px) {
      .game-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .game-card-grid {
        gap: 12px;
      }

      .game-card-column {
        gap: 8px;
      }

      .game-card {
        padding: 12px;
      }

      .game-card-main {
        font-size: 1.05rem;
      }
    }

    [hidden] {
      display: none !important;
    }

    footer {
      text-align: center;
      padding: 24px 16px 32px;
      font-size: 0.85rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>NederLingo</h1>
    <p>
      日本語とオランダ語のフレーズ練習を、目的に合わせて切り替えられるマルチモード学習体験にアップデートしました。
    </p>
    <p>
      落ち着いて発音や意味を確認できる「フレーズ学習モード」と、今後公開予定の対戦要素を備えた「フレーズチャレンジモード」を切り替えて、自分に合ったリズムで学びましょう。
    </p>
  </header>

  <main>
    <div class="main-container" data-active-mode="study">
      <div class="mode-switcher" role="tablist" aria-label="学習モードの選択">
        <button
          id="mode-tab-study"
          class="mode-button"
          type="button"
          role="tab"
          aria-controls="mode-panel-study"
          aria-selected="true"
          data-mode="study"
        >
          フレーズ学習モード
        </button>
        <button
          id="mode-tab-game"
          class="mode-button"
          type="button"
          role="tab"
          aria-controls="mode-panel-game"
          aria-selected="false"
          tabindex="-1"
          data-mode="game"
        >
          フレーズチャレンジモード
        </button>
      </div>

      <div class="mode-panel-group">
        <section
          id="mode-panel-study"
          class="mode-panel"
          role="tabpanel"
          aria-labelledby="mode-tab-study"
          aria-hidden="false"
          data-mode-panel="study"
        >
          <section class="card">
            <h2>次のステップ</h2>
            <ul class="setup-list">
              <li>日本語⇔オランダ語のフレーズデータを整備する</li>
              <li>カテゴリ別に閲覧・練習できるUIを設計する</li>
              <li>検索や発音サポートなどの機能を検討する</li>
            </ul>
          </section>

          <section class="speech-toolbar" aria-label="音声サポート">
            <div class="speech-toolbar-row">
              <div class="speech-controls">
                <label for="speech-rate">再生速度 <span id="speech-rate-value">1.0x</span></label>
                <input
                  type="range"
                  id="speech-rate"
                  name="speech-rate"
                  min="0.6"
                  max="1.4"
                  step="0.1"
                  value="1"
                >
              </div>
              <div id="speech-feedback" class="speech-feedback" aria-live="polite">
                <p id="recognition-target" class="speech-feedback-target">-</p>
                <p id="recognition-live" class="speech-feedback-live" hidden>
                  <span class="speech-feedback-icon" aria-hidden="true">🎙</span>
                  <span id="recognition-text" class="speech-feedback-text">-</span>
                  <span id="recognition-score" class="speech-feedback-score">-</span>
                </p>
                <span id="recognition-status" class="visually-hidden">録音待機中です。</span>
              </div>
            </div>
            <p id="speech-recognition-notice" class="speech-notice is-hidden" aria-live="polite"></p>
          </section>
          <section class="card phrase-section">
            <h3>挨拶</h3>
            <table class="phrase-table">
              <thead>
                <tr>
                  <th scope="col">日本語</th>
                  <th scope="col">オランダ語</th>
                  <th scope="col">カタカナ・発音ヒント</th>
                </tr>
              </thead>
              <tbody>
                <tr data-phrase-id="greet-morning">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">丁寧な朝の挨拶</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="greet-morning"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="greet-morning"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="greet-day">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">日中の挨拶</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="greet-day"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="greet-day"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="greet-evening">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">夕方以降の挨拶</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="greet-evening"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="greet-evening"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="greet-meet">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">初対面の挨拶</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="greet-meet"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="greet-meet"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="greet-bye">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">別れの挨拶</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="greet-bye"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="greet-bye"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="greet-later">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">カジュアルな別れ</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="greet-later"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="greet-later"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
              </tbody>
            </table>
          </section>

          <section class="card phrase-section">
            <h3>旅行</h3>
            <table class="phrase-table">
              <thead>
                <tr>
                  <th scope="col">日本語</th>
                  <th scope="col">オランダ語</th>
                  <th scope="col">カタカナ・発音ヒント</th>
                </tr>
              </thead>
              <tbody>
                <tr data-phrase-id="travel-station">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">場所を尋ねる</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="travel-station"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="travel-station"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="travel-train">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="travel-train"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="travel-train"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="travel-ticket">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="travel-ticket"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="travel-ticket"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="travel-checkin">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">ホテルで</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="travel-checkin"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="travel-checkin"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="travel-restaurant">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="travel-restaurant"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="travel-restaurant"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="emergency-help">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                    <span class="phrase-note">緊急時</span>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="emergency-help"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="emergency-help"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
                <tr data-phrase-id="travel-restroom">
                  <td data-label="日本語">
                    <strong data-phrase-field="ja"></strong>
                  </td>
                  <td data-label="オランダ語">
                    <span class="phrase-dutch" data-phrase-field="nl"></span>
                    <div class="phrase-actions" role="group" aria-label="音声操作">
                      <button
                        type="button"
                        class="icon-button speak-control"
                        data-phrase-id="travel-restroom"
                        aria-label="オランダ語フレーズを再生"
                      >
                        <span aria-hidden="true">🔊</span>
                      </button>
                      <button
                        type="button"
                        class="icon-button recognize-control"
                        data-phrase-id="travel-restroom"
                        aria-label="オランダ語フレーズの発声をテスト"
                      >
                        <span aria-hidden="true">🎤</span>
                      </button>
                    </div>
                  </td>
                  <td data-label="カタカナ・発音ヒント">
                    <span data-phrase-field="hint"></span>
                  </td>
                </tr>
              </tbody>
            </table>
          </section>
        </section>

        <section
          id="mode-panel-game"
          class="mode-panel"
          role="tabpanel"
          aria-labelledby="mode-tab-game"
          data-mode-panel="game"
          hidden
          aria-hidden="true"
        >
          <section class="card game-section">
            <div class="game-intro">
              <h2>フレーズチャレンジモード</h2>
              <p>
                日本語カードとオランダ語カードをタップしてペアを見つける、テンポの良いマッチングゲームです。耳と目を同時に使いながら、短時間で何度も遊んでみましょう。
              </p>
            </div>
            <div class="game-meta">
              <div class="meta-box" aria-live="polite">
                <span class="meta-label">Stage</span>
                <span class="meta-value"><span id="game-stage">0</span><small>段</small></span>
              </div>
              <div class="meta-box" aria-live="polite">
                <span class="meta-label">Score</span>
                <span class="meta-value" id="game-score">0</span>
              </div>
              <div class="meta-box" aria-live="polite">
                <span class="meta-label">連続正解</span>
                <span class="meta-value"><span id="game-streak">0</span><small id="game-best">BEST 0</small></span>
              </div>
            </div>
            <div class="game-controls">
              <button id="game-start-button" class="game-button" type="button">ステージを始める</button>
              <button id="game-reset-button" class="game-button secondary" type="button">スコアをリセット</button>
            </div>
            <p id="game-status" class="game-status" aria-live="polite">ステージを始めてカードをマッチさせましょう！</p>
            <div
              id="game-grid"
              class="game-card-grid"
              aria-label="日本語とオランダ語のカードをマッチさせるグリッド"
              aria-live="polite"
            ></div>
          </section>
        </section>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2024 NederLingo. All rights reserved.
  </footer>

  <script>
    const PHRASE_DATA = [
      {
        id: 'greet-morning',
        category: 'greetings',
        ja: 'おはようございます。',
        nl: 'Goedemorgen.',
        hint: 'フーデモルヘン /ɣudəˈmɔr.ɣə(n)/',
        featured: true,
      },
      {
        id: 'greet-day',
        category: 'greetings',
        ja: 'こんにちは。',
        nl: 'Goedemiddag.',
        hint: 'フーデミダフ /ɣudəˈmɪdɑx/',
      },
      {
        id: 'greet-evening',
        category: 'greetings',
        ja: 'こんばんは。',
        nl: 'Goedenavond.',
        hint: 'フーデナーフォント /ɣudəˈnaːvɔnt/',
      },
      {
        id: 'greet-meet',
        category: 'greetings',
        ja: 'はじめまして。',
        nl: 'Aangenaam.',
        hint: 'アーネナーム /ˈaːŋɣənaːm/',
      },
      {
        id: 'greet-bye',
        category: 'greetings',
        ja: 'さようなら。',
        nl: 'Tot ziens.',
        hint: 'トッツィンス /tɔt ˈzins/',
      },
      {
        id: 'greet-later',
        category: 'greetings',
        ja: 'また後でね。',
        nl: 'Tot later.',
        hint: 'トト ラーテル /tɔt ˈlaːtər/',
      },
      {
        id: 'polite-thanks',
        category: 'essentials',
        ja: 'ありがとうございます。',
        nl: 'Dank u wel.',
        hint: 'ダンク ウ ヴェル /dɑŋk y ʋɛl/',
        featured: true,
      },
      {
        id: 'polite-sorry',
        category: 'essentials',
        ja: 'すみません。',
        nl: 'Pardon.',
        hint: 'パルドン /ˈpɑr.dɔn/',
        featured: true,
      },
      {
        id: 'travel-station',
        category: 'travel',
        ja: '駅はどこですか？',
        nl: 'Waar is het station?',
        hint: 'ワール イス ヘット スタシオン /ʋaːr ɪs ɦət stɑˈʃɔn/',
        featured: true,
      },
      {
        id: 'travel-train',
        category: 'travel',
        ja: 'この列車はアムステルダム行きですか？',
        nl: 'Gaat deze trein naar Amsterdam?',
        hint: 'ハート デーゼ トライン ナール アムステルダム /ɣaːt ˈdeːzə trɛi̯n naːr ˌɑmstərˈdɑm/',
      },
      {
        id: 'travel-ticket',
        category: 'travel',
        ja: '切符を2枚ください。',
        nl: 'Mag ik twee kaartjes alstublieft?',
        hint: 'マッ フィック トゥウェー カールチェス アルストュブリーフト /mɑx ɪk tveː ˈkaːr.cəs ˌɑlstʏˈblift/',
      },
      {
        id: 'travel-checkin',
        category: 'travel',
        ja: 'チェックインをお願いします。',
        nl: 'Ik wil graag inchecken.',
        hint: 'イク ヴィル フラーフ インチェッケン /ɪk ʋɪl ɣraːx ˈɪnˌtʃɛkə(n)/',
      },
      {
        id: 'travel-restaurant',
        category: 'travel',
        ja: 'おすすめのレストランはありますか？',
        nl: 'Heeft u een aanbeveling voor een restaurant?',
        hint: 'ヘーフトゥー ウン アーンベーフェイリング フォール ウン レストラン /ɦeːft y ʏn ˈaːm.beːˌveː.lɪŋ foːr ʏn ˌrɛstɔˈrɑnt/',
      },
      {
        id: 'emergency-help',
        category: 'essentials',
        ja: '助けが必要です。',
        nl: 'Ik heb hulp nodig.',
        hint: 'イク ヘップ フルプ ノーディフ /ɪk ɦɛb ɦʏlp ˈnoːdɪx/',
        featured: true,
      },
      {
        id: 'travel-restroom',
        category: 'travel',
        ja: 'トイレはどこですか？',
        nl: 'Waar is het toilet?',
        hint: 'ワール イス ヘット トワレット /ʋaːr ɪs ɦət twɑˈlɛt/',
      },
    ];

    const PHRASE_LOOKUP = new Map(PHRASE_DATA.map((phrase) => [phrase.id, phrase]));

    const initializePhraseTables = () => {
      const rows = document.querySelectorAll('[data-phrase-id]');

      rows.forEach((row) => {
        const phraseId = row.getAttribute('data-phrase-id');

        if (!phraseId) {
          return;
        }

        const phrase = PHRASE_LOOKUP.get(phraseId);

        if (!phrase) {
          return;
        }

        row.querySelectorAll('[data-phrase-field]').forEach((field) => {
          const fieldName = field.getAttribute('data-phrase-field');

          if (fieldName === 'ja') {
            field.textContent = phrase.ja;
          } else if (fieldName === 'nl') {
            field.textContent = phrase.nl;
          } else if (fieldName === 'hint') {
            field.textContent = phrase.hint ?? '―';
          }
        });

        const speakButton = row.querySelector('.speak-control');

        if (speakButton) {
          const speakLabel = `「${phrase.ja}」をオランダ語で再生`;
          speakButton.dataset.phraseId = phrase.id;
          speakButton.dataset.defaultLabel = speakLabel;
          speakButton.dataset.activeLabel = `「${phrase.ja}」を再生中`;
          speakButton.setAttribute('aria-label', speakLabel);
        }

        const recognizeButton = row.querySelector('.recognize-control');

        if (recognizeButton) {
          const recognizeLabel = `マイクで「${phrase.nl}」（${phrase.ja}）を発声してみよう`;
          recognizeButton.dataset.phraseId = phrase.id;
          recognizeButton.dataset.defaultLabel = recognizeLabel;
          recognizeButton.dataset.activeLabel = `「${phrase.nl}」を録音中`;
          recognizeButton.setAttribute('aria-label', recognizeLabel);
        }
      });
    };

    initializePhraseTables();

    const shuffleArray = (input) => {
      const array = [...input];

      for (let i = array.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }

      return array;
    };

    const modeContainer = document.querySelector('.main-container');
    const modeButtons = modeContainer
      ? Array.from(modeContainer.querySelectorAll('[data-mode]'))
      : [];
    const modePanels = modeContainer
      ? Array.from(modeContainer.querySelectorAll('[data-mode-panel]'))
      : [];

    if (modeContainer && modeButtons.length > 0 && modePanels.length > 0) {
      const setActiveMode = (mode) => {
        modeContainer.dataset.activeMode = mode;

        modeButtons.forEach((button) => {
          const targetMode = button.getAttribute('data-mode');
          const isActive = targetMode === mode;

          button.setAttribute('aria-selected', String(isActive));
          button.setAttribute('tabindex', isActive ? '0' : '-1');
        });

        modePanels.forEach((panel) => {
          const panelMode = panel.getAttribute('data-mode-panel');
          const isActive = panelMode === mode;

          panel.toggleAttribute('hidden', !isActive);
          panel.setAttribute('aria-hidden', String(!isActive));
        });
      };

      const availableModes = modeButtons
        .map((button) => button.getAttribute('data-mode'))
        .filter((value) => typeof value === 'string' && value.length > 0);

      let initialMode = modeContainer.dataset.activeMode;

      if (!initialMode || !availableModes.includes(initialMode)) {
        initialMode = availableModes[0];
      }

      setActiveMode(initialMode);

      modeButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const mode = button.getAttribute('data-mode');

          if (!mode) {
            return;
          }

          setActiveMode(mode);
        });

        button.addEventListener('keydown', (event) => {
          const currentIndex = modeButtons.indexOf(button);
          let targetIndex = null;

          if (event.key === 'ArrowRight' || event.key === 'ArrowDown') {
            targetIndex = (currentIndex + 1) % modeButtons.length;
          } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {
            targetIndex =
              (currentIndex - 1 + modeButtons.length) % modeButtons.length;
          } else if (event.key === 'Home') {
            targetIndex = 0;
          } else if (event.key === 'End') {
            targetIndex = modeButtons.length - 1;
          }

          if (targetIndex !== null) {
            event.preventDefault();

            const targetButton = modeButtons[targetIndex];
            const mode = targetButton?.getAttribute('data-mode');

            if (mode) {
              setActiveMode(mode);
              targetButton.focus();
            }
          }
        });
      });
    }

    const rateSlider = document.getElementById('speech-rate');
    const rateValue = document.getElementById('speech-rate-value');
    const speechFeedback = document.getElementById('speech-feedback');
    const recognitionStatus = document.getElementById('recognition-status');
    const recognitionTarget = document.getElementById('recognition-target');
    const recognitionText = document.getElementById('recognition-text');
    const recognitionScore = document.getElementById('recognition-score');
    const recognitionLive = document.getElementById('recognition-live');
    const recognitionNotice = document.getElementById('speech-recognition-notice');

    const defaultStatusMessage =
      recognitionStatus?.textContent?.trim() || '録音待機中です。';

    let recognitionAudioContext = null;

    const ensureRecognitionAudioContext = () => {
      const AudioContextClass = window.AudioContext || window.webkitAudioContext;

      if (!AudioContextClass) {
        return null;
      }

      if (!recognitionAudioContext) {
        recognitionAudioContext = new AudioContextClass();
      }

      if (recognitionAudioContext.state === 'suspended') {
        recognitionAudioContext.resume().catch(() => {
          /* noop */
        });
      }

      return recognitionAudioContext;
    };

    const playRecognitionTone = (isPerfectMatch) => {
      const context = ensureRecognitionAudioContext();

      if (!context) {
        return;
      }

      const oscillator = context.createOscillator();
      const gainNode = context.createGain();
      const now = context.currentTime;

      oscillator.type = isPerfectMatch ? 'triangle' : 'sine';

      if (isPerfectMatch) {
        oscillator.frequency.setValueAtTime(880, now);
        oscillator.frequency.exponentialRampToValueAtTime(1320, now + 0.22);
      } else {
        oscillator.frequency.setValueAtTime(320, now);
        oscillator.frequency.exponentialRampToValueAtTime(220, now + 0.22);
      }

      gainNode.gain.setValueAtTime(0.0001, now);
      gainNode.gain.exponentialRampToValueAtTime(0.25, now + 0.04);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.32);

      oscillator.connect(gainNode);
      gainNode.connect(context.destination);

      oscillator.start(now);
      oscillator.stop(now + 0.34);
    };

    const showRecognitionLive = () => {
      if (recognitionLive) {
        recognitionLive.hidden = false;
      }
    };

    const hideRecognitionLive = () => {
      if (recognitionLive) {
        recognitionLive.hidden = true;
      }
    };

    if (recognitionStatus) {
      recognitionStatus.dataset.defaultMessage = defaultStatusMessage;
      recognitionStatus.dataset.state = recognitionStatus.dataset.state || 'idle';
    }

    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;

    if (rateSlider && rateValue) {
      const updateRateLabel = () => {
        rateValue.textContent = `${parseFloat(rateSlider.value).toFixed(1)}x`;
      };

      rateSlider.addEventListener('input', updateRateLabel);
      updateRateLabel();
    }

    if ('speechSynthesis' in window) {
      const synthesis = window.speechSynthesis;
      let availableVoices = [];
      let activeButton = null;

      const restoreStatusAfterSpeech = () => {
        if (
          recognitionStatus &&
          recognitionStatus.dataset.state === 'speaking'
        ) {
          const previous =
            recognitionStatus.dataset.previousStatus || defaultStatusMessage;
          recognitionStatus.textContent = previous;
          recognitionStatus.dataset.state = 'idle';
          delete recognitionStatus.dataset.previousStatus;
        }
      };

      const markStatusForSpeech = () => {
        if (!recognitionStatus) {
          return;
        }

        recognitionStatus.dataset.previousStatus =
          recognitionStatus.textContent?.trim() || defaultStatusMessage;
        recognitionStatus.dataset.state = 'speaking';
        recognitionStatus.textContent = '再生中です…';
      };

      const refreshVoices = () => {
        availableVoices = synthesis
          .getVoices()
          .filter((voice) => voice.lang && voice.lang.toLowerCase().startsWith('nl'));

        if (availableVoices.length === 0) {
          availableVoices = synthesis.getVoices();
        }
      };

      const resetActiveButton = () => {
        restoreStatusAfterSpeech();

        if (activeButton) {
          activeButton.disabled = false;
          activeButton.classList.remove('is-active');
          const defaultLabel =
            activeButton.dataset.defaultLabel ?? 'オランダ語フレーズを再生';
          activeButton.setAttribute('aria-label', defaultLabel);
          activeButton = null;
        }
      };

      const speakFromButton = (button) => {
        const phraseId = button.dataset.phraseId;
        const phrase = phraseId ? PHRASE_LOOKUP.get(phraseId) : null;
        const dutchText = phrase?.nl?.trim();

        if (!phrase || !dutchText) {
          return;
        }

        if (synthesis.speaking || synthesis.pending) {
          synthesis.cancel();
        }

        resetActiveButton();

        const utterance = new SpeechSynthesisUtterance(dutchText);
        utterance.lang = 'nl-NL';

        if (rateSlider) {
          utterance.rate = parseFloat(rateSlider.value) || 1;
        }

        const selectedVoice = availableVoices.find(
          (voice) => voice.lang && voice.lang.toLowerCase().startsWith('nl')
        );

        if (selectedVoice) {
          utterance.voice = selectedVoice;
        }

        if (speechFeedback) {
          speechFeedback.classList.remove('is-hidden');
        }

        if (recognitionTarget) {
          recognitionTarget.textContent = dutchText;
        }

        markStatusForSpeech();

        utterance.onend = () => {
          restoreStatusAfterSpeech();

          if (activeButton === button) {
            resetActiveButton();
          }
        };

        utterance.onerror = () => {
          restoreStatusAfterSpeech();

          if (activeButton === button) {
            resetActiveButton();
          }
        };

        activeButton = button;
        button.disabled = true;
        button.classList.add('is-active');
        const activeLabel = button.dataset.activeLabel ?? '再生中…';
        button.setAttribute('aria-label', activeLabel);

        synthesis.speak(utterance);
      };

      const handleSpeakClick = (event) => {
        const button = event.target.closest('.speak-control');

        if (!button) {
          return;
        }

        event.preventDefault();
        event.stopPropagation();

        if (availableVoices.length === 0) {
          refreshVoices();
        }

        speakFromButton(button);
      };

      refreshVoices();
      synthesis.addEventListener('voiceschanged', refreshVoices);
      document.addEventListener('click', handleSpeakClick);
    }

    const sanitizePhrase = (text) =>
      text
        .toLowerCase()
        .replace(/[^a-zà-ž\s']/gi, ' ')
        .replace(/\s+/g, ' ')
        .trim();

    const computeSimilarity = (a, b) => {
      const source = sanitizePhrase(a);
      const target = sanitizePhrase(b);

      if (!source && !target) {
        return 1;
      }

      if (!source || !target) {
        return 0;
      }

      const rows = source.length + 1;
      const cols = target.length + 1;
      const dp = Array.from({ length: rows }, () => new Array(cols).fill(0));

      for (let i = 0; i < rows; i += 1) {
        dp[i][0] = i;
      }

      for (let j = 0; j < cols; j += 1) {
        dp[0][j] = j;
      }

      for (let i = 1; i < rows; i += 1) {
        for (let j = 1; j < cols; j += 1) {
          const cost = source[i - 1] === target[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }

      const distance = dp[rows - 1][cols - 1];
      const longest = Math.max(source.length, target.length);

      return longest === 0 ? 1 : 1 - distance / longest;
    };

      if (
        recognitionNotice &&
        speechFeedback &&
        recognitionStatus &&
        recognitionTarget &&
        recognitionText &&
        recognitionScore
      ) {
        if (!SpeechRecognition) {
          document.querySelectorAll('.recognize-control').forEach((button) => {
            const defaultLabel = button.dataset.defaultLabel || button.getAttribute('aria-label');
            if (defaultLabel) {
              button.setAttribute('aria-label', `${defaultLabel} (音声認識は利用できません)`);
            }
            button.disabled = true;
          });
          recognitionNotice.textContent =
            'お使いのブラウザは音声認識に対応していません。Chromeなどの対応ブラウザでお試しください。';
          recognitionNotice.classList.remove('is-hidden');
          recognitionStatus.textContent = '音声認識は利用できません。';
          recognitionStatus.dataset.state = 'idle';
          delete recognitionStatus.dataset.previousStatus;
        } else {
          document.querySelectorAll('.recognize-control').forEach((button) => {
            if (button.dataset.defaultLabel) {
              button.setAttribute('aria-label', button.dataset.defaultLabel);
            }
            button.disabled = false;
          });
          speechFeedback.classList.remove('is-hidden');
          recognitionNotice.textContent = '初回利用時はマイクアイコンを押す際にブラウザのマイク許可が求められます。';
          recognitionNotice.classList.remove('is-hidden');
          recognitionStatus.textContent = defaultStatusMessage;
          recognitionStatus.dataset.state = 'idle';
          delete recognitionStatus.dataset.previousStatus;

        const recognition = new SpeechRecognition();
        recognition.lang = 'nl-NL';
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        let activeRecognitionButton = null;
        let targetPhrase = '';

        const releaseRecognitionButton = () => {
          if (activeRecognitionButton) {
            activeRecognitionButton.disabled = false;
            activeRecognitionButton.classList.remove('is-recording');
            const defaultLabel =
              activeRecognitionButton.dataset.defaultLabel ?? 'オランダ語フレーズの発声をテスト';
            activeRecognitionButton.setAttribute('aria-label', defaultLabel);
            activeRecognitionButton = null;
          }
        };

        recognition.addEventListener('start', () => {
          showRecognitionLive();

          if (recognitionText) {
            recognitionText.textContent = '聴き取り中…';
          }

          if (recognitionScore) {
            recognitionScore.textContent = '-';
          }

          if (recognitionStatus) {
            recognitionStatus.dataset.previousStatus =
              recognitionStatus.textContent?.trim() || defaultStatusMessage;
            recognitionStatus.dataset.state = 'recognition';
            recognitionStatus.textContent = '録音中です。話し終えたら自動的に判定します。';
          }
        });

        recognition.addEventListener('result', (event) => {
          const transcript = event.results[0][0]?.transcript?.trim() ?? '';
          recognitionText.textContent = transcript || '-';
          recognitionTarget.textContent = targetPhrase || '-';

          const similarity = computeSimilarity(transcript, targetPhrase);
          const percentage = Math.round(similarity * 100);
          recognitionScore.textContent = Number.isNaN(percentage) ? '-' : `${percentage}%`;

          if (transcript && targetPhrase) {
            const isPerfectMatch = !Number.isNaN(percentage) && percentage === 100;
            playRecognitionTone(isPerfectMatch);
          }
        });

        recognition.addEventListener('error', (event) => {
          recognitionStatus.textContent = `エラーが発生しました: ${event.error}`;
          recognitionStatus.dataset.state = 'idle';
          delete recognitionStatus.dataset.previousStatus;
          recognitionText.textContent = '-';
          recognitionScore.textContent = '-';
          hideRecognitionLive();
          releaseRecognitionButton();
        });

        recognition.addEventListener('nomatch', () => {
          recognitionStatus.textContent = '音声を認識できませんでした。もう一度お試しください。';
          recognitionStatus.dataset.state = 'idle';
          delete recognitionStatus.dataset.previousStatus;
          recognitionText.textContent = '-';
          recognitionScore.textContent = '-';
          hideRecognitionLive();
        });

        recognition.addEventListener('end', () => {
          releaseRecognitionButton();

          if (recognitionStatus) {
            if (recognitionStatus.dataset.state === 'recognition') {
              recognitionStatus.textContent =
                recognitionStatus.dataset.previousStatus || defaultStatusMessage;
            }
            recognitionStatus.dataset.state = 'idle';
            delete recognitionStatus.dataset.previousStatus;
          }
        });

        const handleRecognitionClick = (event) => {
          const button = event.target.closest('.recognize-control');

          if (!button) {
            return;
          }

          event.preventDefault();
          event.stopPropagation();

          const phraseId = button.dataset.phraseId;
          const phrase = phraseId ? PHRASE_LOOKUP.get(phraseId) : null;
          const dutchText = phrase?.nl?.trim();

          if (!phrase || !dutchText) {
            return;
          }

          if (activeRecognitionButton) {
            try {
              recognition.abort();
            } catch (error) {
              /* noop */
            }
            releaseRecognitionButton();
          }

          targetPhrase = dutchText;
          recognitionTarget.textContent = dutchText;
          recognitionText.textContent = '-';
          recognitionScore.textContent = '-';
          hideRecognitionLive();

          activeRecognitionButton = button;
          button.disabled = true;
          button.classList.add('is-recording');
          const activeLabel = button.dataset.activeLabel ?? '録音中…';
          button.setAttribute('aria-label', activeLabel);

          try {
            recognition.start();
          } catch (error) {
            recognitionStatus.textContent =
              '音声認識の開始に失敗しました。もう一度お試しください。';
            recognitionStatus.dataset.state = 'idle';
            delete recognitionStatus.dataset.previousStatus;
            releaseRecognitionButton();
            targetPhrase = '';
            recognitionTarget.textContent = '-';
            recognitionText.textContent = '-';
            recognitionScore.textContent = '-';
            hideRecognitionLive();
          }
        };

        document.addEventListener('click', handleRecognitionClick);

        window.addEventListener('beforeunload', () => {
          try {
            recognition.stop();
          } catch (error) {
            /* noop */
          }
        });
      }
    }

    const gameGrid = document.getElementById('game-grid');
    const gameStatus = document.getElementById('game-status');
    const stageDisplay = document.getElementById('game-stage');
    const scoreDisplay = document.getElementById('game-score');
    const streakDisplay = document.getElementById('game-streak');
    const bestDisplay = document.getElementById('game-best');
    const startButton = document.getElementById('game-start-button');
    const resetButton = document.getElementById('game-reset-button');

    const gameState = {
      stage: 0,
      score: 0,
      streak: 0,
      best: 0,
      matchesRemaining: 0,
      selection: [],
      busy: false,
    };

    const pulseElement = (element) => {
      if (!element) {
        return;
      }

      element.classList.remove('score-pulse');
      void element.offsetWidth;
      element.classList.add('score-pulse');
    };

    const stagePairCount = () => Math.min(5, PHRASE_DATA.length);

    const setStatus = (message) => {
      if (gameStatus) {
        gameStatus.textContent = message;
      }
    };

    const updateScoreboard = () => {
      if (stageDisplay) {
        stageDisplay.textContent = gameState.stage;
      }

      if (scoreDisplay) {
        scoreDisplay.textContent = gameState.score;
      }

      if (streakDisplay) {
        streakDisplay.textContent = gameState.streak;
      }

      if (bestDisplay) {
        bestDisplay.textContent = `BEST ${gameState.best}`;
      }
    };

    const createGameCard = (phrase, lang) => {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.dataset.pairId = phrase.id;
      card.dataset.lang = lang;

      const mainButton = document.createElement('button');
      mainButton.type = 'button';
      mainButton.className = 'game-card-main';

      const labelText = lang === 'ja' ? '日本語カード' : 'オランダ語カード';
      const displayText = lang === 'ja' ? phrase.ja : phrase.nl;
      mainButton.setAttribute('aria-label', `${labelText}: ${displayText}`);

      const textSpan = document.createElement('span');
      textSpan.className = 'game-card-text';
      textSpan.textContent = displayText;

      mainButton.append(textSpan);

      card.append(mainButton);

      return card;
    };

    const createCardColumn = (lang) => {
      const column = document.createElement('div');
      column.className = 'game-card-column';
      column.dataset.lang = lang;
      column.setAttribute(
        'aria-label',
        lang === 'nl' ? 'オランダ語のカード' : '日本語のカード'
      );
      column.setAttribute('role', 'group');
      return column;
    };

    const resetGame = (announce = true) => {
      gameState.stage = 0;
      gameState.score = 0;
      gameState.streak = 0;
      gameState.best = 0;
      gameState.matchesRemaining = 0;
      gameState.selection = [];
      gameState.busy = false;
      updateScoreboard();

      if (gameGrid) {
        gameGrid.innerHTML = '';
      }

      if (startButton) {
        startButton.disabled = false;
        startButton.textContent = 'ステージを始める';
      }

      if (announce) {
        setStatus('ステージを始めてカードをマッチさせましょう！');
      }
    };

    const stageClearFeedback = () => {
      const bonus = 20;
      gameState.score += bonus;
      updateScoreboard();
      pulseElement(scoreDisplay);

      if (startButton) {
        startButton.disabled = false;
        startButton.textContent = '次のステージへ';
      }

      setStatus(`✨ ステージ${gameState.stage}クリア！ボーナス${bonus}点を獲得したよ。`);
    };

    const evaluateSelection = () => {
      if (gameState.selection.length < 2) {
        return;
      }

      gameState.busy = true;

      const [first, second] = gameState.selection;
      const isMatch = first.pairId === second.pairId && first.lang !== second.lang;

      if (isMatch) {
        const phrase = PHRASE_LOOKUP.get(first.pairId);
        [first.card, second.card].forEach((card) => {
          card.classList.remove('is-selected');
          card.classList.add('is-matched', 'is-disabled');
        });

        gameState.matchesRemaining -= 1;
        gameState.streak += 1;

        if (gameState.streak > gameState.best) {
          gameState.best = gameState.streak;
        }

        const gained = 10 + gameState.streak * 2;
        gameState.score += gained;
        updateScoreboard();
        pulseElement(scoreDisplay);
        pulseElement(streakDisplay);

        if (phrase) {
          setStatus(`🎉 正解！「${phrase.ja}」と「${phrase.nl}」で${gained}点ゲット！`);
        } else {
          setStatus('🎉 正解！すばらしい！');
        }

        gameState.selection = [];
        gameState.busy = false;

        if (gameState.matchesRemaining === 0) {
          stageClearFeedback();
        }

        return;
      }

      gameState.streak = 0;
      updateScoreboard();
      pulseElement(streakDisplay);
      setStatus('あれ？違うみたい。落ち着いてもう一度！');

      const [firstCard, secondCard] = [first.card, second.card];

      setTimeout(() => {
        firstCard.classList.remove('is-selected');
        secondCard.classList.remove('is-selected');
        gameState.selection = [];
        gameState.busy = false;
      }, 700);
    };

    const handleCardSelection = (card) => {
      if (!card || gameState.busy) {
        return;
      }

      if (card.classList.contains('is-matched') || card.classList.contains('is-disabled')) {
        return;
      }

      const pairId = card.getAttribute('data-pair-id');
      const lang = card.getAttribute('data-lang');

      if (!pairId || !lang) {
        return;
      }

      if (gameState.selection.length === 0) {
        gameState.selection.push({ card, pairId, lang });
        card.classList.add('is-selected');
        setStatus('もう1枚選んでペアを作ろう！');
        return;
      }

      const [firstSelection] = gameState.selection;

      if (firstSelection.card === card) {
        card.classList.remove('is-selected');
        gameState.selection = [];
        setStatus('カードを選び直したよ。');
        return;
      }

      if (firstSelection.lang === lang) {
        firstSelection.card.classList.remove('is-selected');
        gameState.selection = [{ card, pairId, lang }];
        card.classList.add('is-selected');
        setStatus('もう1枚選んでペアを作ろう！');
        return;
      }

      gameState.selection.push({ card, pairId, lang });
      card.classList.add('is-selected');
      evaluateSelection();
    };

    const startStage = () => {
      if (!gameGrid) {
        return;
      }

      const nextStage = gameState.stage + 1;
      const pairCount = stagePairCount(nextStage);

      if (pairCount <= 0) {
        setStatus('利用できるカードが足りません。');
        return;
      }

      const selectedPairs = shuffleArray(PHRASE_DATA).slice(0, pairCount);
      const cards = shuffleArray(
        selectedPairs.flatMap((phrase) => [
          { phrase, lang: 'ja' },
          { phrase, lang: 'nl' },
        ])
      );

      gameGrid.setAttribute('aria-busy', 'true');
      gameGrid.innerHTML = '';

      const dutchColumn = createCardColumn('nl');
      const japaneseColumn = createCardColumn('ja');

      cards.forEach(({ phrase, lang }) => {
        const targetColumn = lang === 'nl' ? dutchColumn : japaneseColumn;
        targetColumn.appendChild(createGameCard(phrase, lang));
      });

      const fragment = document.createDocumentFragment();
      fragment.append(dutchColumn, japaneseColumn);

      gameGrid.appendChild(fragment);
      gameGrid.removeAttribute('aria-busy');

      gameState.stage = nextStage;
      gameState.matchesRemaining = selectedPairs.length;
      gameState.selection = [];
      gameState.busy = false;

      if (startButton) {
        startButton.disabled = true;
        startButton.textContent = 'プレイ中…';
      }

      updateScoreboard();
      setStatus(`ステージ${gameState.stage}スタート！同じ意味のカードをタップしてね。`);
    };

    if (gameGrid) {
      gameGrid.addEventListener('click', (event) => {
        const mainButton = event.target.closest('.game-card-main');

        if (mainButton) {
          event.preventDefault();
          const card = mainButton.closest('.game-card');
          handleCardSelection(card);
        }
      });
    }

    if (startButton) {
      startButton.addEventListener('click', () => {
        if (startButton.disabled) {
          return;
        }

        startStage();
      });
    }

    if (resetButton) {
      resetButton.addEventListener('click', () => {
        resetGame();
        if (startButton) {
          startButton.focus();
        }
      });
    }

    resetGame();
  </script>

</body>
</html>
